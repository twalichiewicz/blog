<%- partial('_partial/nav') %>

<div class="portfolio">
    <% 
    const currentPage = parseInt(page.current || 1);
    const postsPerPage = 10;

    const blogPosts = site.posts
        .toArray()
        .filter(post => post.tags && post.tags.toArray().some(tag => tag.name === 'blog'))
        .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); // Explicit sort by date

    const totalPages = Math.ceil(blogPosts.length / postsPerPage);
    const paginatedPosts = blogPosts.slice((currentPage - 1) * postsPerPage, currentPage * postsPerPage);
    %>
    
    <% 
    const portfolioPosts = site.posts
        .toArray()
        .filter(post => post.tags && post.tags.data.some(tag => tag.name === 'portfolio') && !post.draft)
        .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); // Sort by date descending
    %>

    <% if (portfolioPosts.length > 0) { %>
        <div class="portfolio-list">
            <% 
            // Get all posts and sort them by date (newest first)
            const allPosts = site.posts.data.sort((a, b) => {
                // Convert dates to timestamps for reliable comparison
                const dateA = new Date(a.date).getTime();
                const dateB = new Date(b.date).getTime();
                return dateB - dateA;
            });

            // Filter for portfolio posts that aren't drafts
            allPosts.forEach(function(post) { 
                if (post.tags && post.tags.data.some(tag => tag.name === 'portfolio') && !post.draft) { %>
                    <a href="<%- url_for(post.path) %>" class="portfolio-item">
                        <% if (post.cover_image) { %>
							<div class="portfolio-image">
								<% 
								// Check if cover_image is a video file
								const isVideo = /\.(mp4|webm|ogg|mov)$/i.test(post.cover_image);
								%>
								<% if (isVideo) { %>
									<video 
										autoplay 
										loop 
										muted 
										playsinline
										preload="metadata"
										data-autoplay="true"
										<% if (post.cover_video_poster) { %>poster="<%- url_for(post.cover_video_poster) %>"<% } %>
										alt="<%- post.title %>"
										loading="lazy"
									>
										<% 
										// Generate compatible video paths
										const basePath = post.cover_image.replace(/\.(mp4|webm|ogg|mov)$/i, '');
										const webmPath = basePath.replace('-simple', '-compatible') + '.webm';
										const mp4Path = basePath.replace('-simple', '-compatible') + '.mp4';
										%>
										<source src="<%- url_for(webmPath) %>" type="video/webm">
										<source src="<%- url_for(mp4Path) %>" type="video/mp4">
										<source src="<%- url_for(post.cover_image) %>" type="video/mp4">
									</video>
								<% } else { %>
								<img 
									src="<%- url_for(post.cover_image) %>" 
									alt="<%- post.title %>"
									loading="lazy"
								>
								<% } %>
							</div>
						<% } %>
                        <div class="portfolio-content">
                            <% if (post.company) { %>
                                <div class="company-byline"><%- post.company %></div>
                            <% } %>
                            <h3><%- post.title %></h3>
                            <% if (post.byline) { %>
                                <p><%- post.byline %></p>
                            <% } %>
                        </div>
                    </a>
                <% } %>
            <% }); %>
        </div>
    <% } else { %>
        <p>No portfolio items available.</p>
    <% } %>
</div>

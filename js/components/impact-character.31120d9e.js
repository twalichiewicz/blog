import*as THREE from"three";const MODEL_COLORS={operator:"#d6d2cc",architect:"#d2d5d2",behavior:"#d4d2d6"};class ImpactCharacterViewer{constructor(t){this.container=t,this.viewport=t.querySelector(".impact-character-viewport"),this.canvas=t.querySelector(".impact-character-canvas"),this.chips=Array.from(t.querySelectorAll(".impact-character-chip")),this.isRunning=!1,this.isDragging=!1,this.pointerTarget={x:0,y:0},this.pointerCurrent={x:0,y:0},this.dragStart={x:0,y:0},this.dragStartRotation={x:0,y:0},this.baseRotation={x:0,y:0},this.archetype=t.getAttribute("data-archetype")||"operator",this.hasReducedMotion=window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches??!1,this.onResize=this.onResize.bind(this),this.onPointerMove=this.onPointerMove.bind(this),this.onPointerDown=this.onPointerDown.bind(this),this.onPointerUp=this.onPointerUp.bind(this),this.animate=this.animate.bind(this),this.onChipClick=this.onChipClick.bind(this)}init(){if(this.initialized)return!0;if(!this.viewport||!this.canvas)return!1;try{return this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(35,1,.1,50),this.camera.position.set(0,1.35,4.2),this.camera.lookAt(0,1.2,0),this.renderer=new THREE.WebGLRenderer({canvas:this.canvas,alpha:!0,antialias:!0,powerPreference:"high-performance"}),this.renderer.setClearColor(0,0),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio||1,2)),this.renderer.outputColorSpace=THREE.SRGBColorSpace,this.renderer.toneMapping=THREE.ACESFilmicToneMapping,this.renderer.toneMappingExposure=1.1,this.buildLights(),this.buildBust(),this.applyArchetype(this.archetype),this.resizeObserver=new ResizeObserver(this.onResize),this.resizeObserver.observe(this.viewport),window.addEventListener("resize",this.onResize),this.viewport.addEventListener("pointermove",this.onPointerMove,{passive:!0}),this.viewport.addEventListener("pointerdown",this.onPointerDown,{passive:!0}),window.addEventListener("pointerup",this.onPointerUp,{passive:!0}),this.chips.forEach(t=>{t.addEventListener("click",this.onChipClick)}),this.onResize(),this.container.classList.add("is-three-ready"),this.initialized=!0,!0}catch(t){return this.destroy(),!1}}buildLights(){const t=new THREE.AmbientLight(16777215,.55);this.scene.add(t);const e=new THREE.DirectionalLight(16777215,1.25);e.position.set(3.5,4,4),this.scene.add(e);const i=new THREE.DirectionalLight(13624319,.55);i.position.set(-3,2.4,3.2),this.scene.add(i);const r=new THREE.DirectionalLight(16771007,.65);r.position.set(0,4.2,-4.5),this.scene.add(r)}buildBust(){this.bustGroup=new THREE.Group,this.scene.add(this.bustGroup);const t=new THREE.MeshStandardMaterial({color:new THREE.Color("#d6d2cc"),roughness:.55,metalness:.12});this.bustMaterial=t;const e=new THREE.Mesh(new THREE.SphereGeometry(.62,64,64),t);e.position.y=1.55,this.bustGroup.add(e);const i=new THREE.Mesh(new THREE.CylinderGeometry(.22,.26,.28,32),t);i.position.y=1.17,this.bustGroup.add(i);const r=new THREE.Mesh(new THREE.CapsuleGeometry(.85,1.02,8,22),t);r.position.y=.42,r.scale.set(1.35,.85,1),this.bustGroup.add(r);const s=new THREE.Mesh(new THREE.CylinderGeometry(.7,.9,1.05,36,1,!0),t);s.position.y=-.25,s.scale.set(1.1,1,.75),this.bustGroup.add(s),this.bustGroup.rotation.y=.35,this.baseRotation.x=this.bustGroup.rotation.x,this.baseRotation.y=this.bustGroup.rotation.y}onResize(){if(!this.renderer||!this.camera||!this.viewport)return;const t=this.viewport.getBoundingClientRect(),e=Math.max(1,Math.floor(t.width)),i=Math.max(1,Math.floor(t.height));this.renderer.setSize(e,i,!1),this.camera.aspect=e/i,this.camera.updateProjectionMatrix(),this.renderOnce()}renderOnce(){this.renderer&&this.scene&&this.camera&&this.renderer.render(this.scene,this.camera)}onPointerMove(t){if(!this.viewport)return;const e=this.viewport.getBoundingClientRect(),i=(t.clientX-e.left)/e.width*2-1,r=-((t.clientY-e.top)/e.height*2-1);if(this.pointerTarget.x=i,this.pointerTarget.y=r,this.isDragging){const e=t.clientX-this.dragStart.x,i=t.clientY-this.dragStart.y;this.dragRotationTargetY=this.dragStartRotation.y+.006*e,this.dragRotationTargetX=this.dragStartRotation.x+.004*i}}onPointerDown(t){this.isDragging=!0,this.dragStart.x=t.clientX,this.dragStart.y=t.clientY,this.dragStartRotation.x=this.dragRotationTargetX||0,this.dragStartRotation.y=this.dragRotationTargetY||0}onPointerUp(){this.isDragging=!1}onChipClick(t){const e=t.currentTarget,i=e?.dataset?.archetype;i&&i!==this.archetype&&(this.archetype=i,this.container.setAttribute("data-archetype",i),this.chips.forEach(t=>{const i=t===e;t.classList.toggle("is-active",i),t.setAttribute("aria-selected",i?"true":"false")}),this.applyArchetype(i))}applyArchetype(t){this.bustMaterial&&(this.bustMaterial.color.set(MODEL_COLORS[t]||MODEL_COLORS.operator),this.bustMaterial.needsUpdate=!0)}start(){this.initialized&&!this.isRunning&&(this.isRunning=!0,this.lastTime=performance.now(),this.animationFrameId=requestAnimationFrame(this.animate))}stop(){this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animate(t){if(!(this.isRunning&&this.renderer&&this.camera&&this.scene&&this.bustGroup))return;const e=Math.min(64,t-(this.lastTime||t));this.lastTime=t,this.pointerCurrent.x+=(this.pointerTarget.x-this.pointerCurrent.x)*(this.hasReducedMotion?.08:.12),this.pointerCurrent.y+=(this.pointerTarget.y-this.pointerCurrent.y)*(this.hasReducedMotion?.08:.12);const i=this.dragRotationTargetY||0,r=this.dragRotationTargetX||0,s=this.baseRotation.y+i+.25*this.pointerCurrent.x,n=this.baseRotation.x+r+.12*this.pointerCurrent.y;this.bustGroup.rotation.y+=(s-this.bustGroup.rotation.y)*(e/120),this.bustGroup.rotation.x+=(n-this.bustGroup.rotation.x)*(e/140),this.renderer.render(this.scene,this.camera),this.animationFrameId=requestAnimationFrame(this.animate)}destroy(){this.stop(),this.chips.forEach(t=>{t.removeEventListener("click",this.onChipClick)}),this.viewport&&(this.viewport.removeEventListener("pointermove",this.onPointerMove),this.viewport.removeEventListener("pointerdown",this.onPointerDown)),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("resize",this.onResize),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.bustGroup&&this.bustGroup.traverse(t=>{t.isMesh&&(t.geometry?.dispose(),Array.isArray(t.material)?t.material.forEach(t=>t.dispose()):t.material?.dispose())}),this.renderer?.dispose(),this.renderer=null,this.scene=null,this.camera=null,this.bustGroup=null,this.bustMaterial=null}}let viewer=null,latestStartToken=0;export function startImpactCharacter(){const t=++latestStartToken,e=document.querySelector(".impact-character[data-impact-character]");e&&(viewer&&viewer.container===e||(viewer?.destroy(),viewer=new ImpactCharacterViewer(e)),viewer.init()&&t===latestStartToken&&viewer.start())}export function stopImpactCharacter(){latestStartToken++,viewer?.stop()}
import ScrollUtility from"../utils/scroll-utility.js";export default class MobileTabs{constructor(t={}){this.config={tabsWrapperSelector:".tabs-wrapper",tabContainerSelector:".mobile-tabs",tabButtonSelector:".tab-button",postsContentId:"postsContent",projectsContentId:"projectsContent",waresContentId:"waresContent",searchBarSelector:".search-bar",activeClass:"active",transitionDuration:400,...t},this.boundListeners={handleTabClick:null,handleResize:null,handleOrientationChange:null,handleSearchTriggerClick:null,handleSearchInputSync:null,handleSearchClear:null,handleSearchKeydown:null,handleOriginalSearchInput:null,handleSearchPostsOnlyClick:null,handleSearchScroll:null,handleStickyScroll:null},this.tabClickListeners=new Map,this.userSelectedTab=null,this.currentDeviceType="",this.initialRenderComplete=!1,this.tabScrollStates=new Map,this.fadeTimeout=null,this.fadeInTimeout=null,this.initialRenderTimeout=null,this.scrollResetTimeouts=new Map,this.animationSuppressedUntil=0,this.searchBarVisibilityTimeout=null,this.pendingLayoutCleanup=null,this.searchOverlayOpen=!1,this.searchVisibilityObserver=null,this.isStickyFixed=!1,this.stickyPlaceholder=null,this.cacheElements(),this.tabContainer&&(this.setupEventListeners(),this.currentDeviceType=this.getDeviceType(),this.handleDeviceChange(!0),this.initializeDesktopView(),this.initializeSlider(),this.validateActiveState(),this.waresContent&&this.resetWaresCarouselScroll(this.waresContent),this.setupSearchIntegration())}cacheElements(){const t=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);console.log("[MobileTabs] Caching DOM elements (Safari:",t+")"),this.tabsWrapper=null,this.tabContainer=null,this.tabButtons=null,this.postsContent=null,this.projectsContent=null,this.waresContent=null,this.searchBar=null,this.searchTrigger=null,this.searchReveal=null,this.tabsSearchInput=null,this.tabsSearchClear=null,this.originalSearchInput=null,this.inlineSearchContainer=null,this.tabsWrapper=document.querySelector(this.config.tabsWrapperSelector),this.tabContainer=document.querySelector(this.config.tabContainerSelector),this.tabContainer&&(this.tabButtons=document.querySelectorAll(this.config.tabButtonSelector),this.postsContent=document.getElementById(this.config.postsContentId),this.projectsContent=document.getElementById(this.config.projectsContentId),this.waresContent=document.getElementById(this.config.waresContentId),this.searchBar=document.querySelector(this.config.searchBarSelector),this.searchTrigger=this.tabContainer?.querySelector(".tabs-search-trigger"),this.searchReveal=this.tabContainer?.querySelector(".tabs-search-reveal"),this.tabsSearchInput=this.searchReveal?.querySelector(".tabs-search-input"),this.tabsSearchClear=this.searchReveal?.querySelector(".tabs-search-clear"),this.tabsSearchPostsOnly=this.searchReveal?.querySelector(".tabs-search-posts-only"),this.tabsButtonsLayer=this.tabContainer?.querySelector(".tabs-buttons-layer"),this.originalSearchInput=document.getElementById("postSearch"),this.originalPostsOnlyButton=this.postsContent?.querySelector(".posts-only-button"),this.inlineSearchContainer=this.postsContent?.querySelector(".search-container"),this.ensurePaneClasses(),console.log("[MobileTabs] Cached elements:",{tabButtons:this.tabButtons.length,postsContent:!!this.postsContent,projectsContent:!!this.projectsContent,waresContent:!!this.waresContent,searchTrigger:!!this.searchTrigger,searchReveal:!!this.searchReveal,isSafari:t}))}setupEventListeners(){this.removeEventListeners(),this.boundListeners.handleResize=this.handleResize.bind(this),this.boundListeners.handleOrientationChange=this.handleDeviceChange.bind(this),this.tabButtons.forEach((t,e)=>{const i=t=>{const e=t.currentTarget.dataset.type;this.switchTab(e,!0)};this.tabClickListeners.set(t,i),t.addEventListener("click",i)}),window.addEventListener("resize",this.boundListeners.handleResize),window.addEventListener("orientationchange",this.boundListeners.handleOrientationChange)}removeEventListeners(){this.tabClickListeners.forEach((t,e)=>{e.removeEventListener("click",t)}),this.tabClickListeners.clear(),this.boundListeners.handleResize&&window.removeEventListener("resize",this.boundListeners.handleResize),this.boundListeners.handleOrientationChange&&window.removeEventListener("orientationchange",this.boundListeners.handleOrientationChange)}destroy(){"function"==typeof this.pendingLayoutCleanup&&(this.pendingLayoutCleanup(),this.pendingLayoutCleanup=null),this.removeEventListeners(),this.cleanupSearchIntegration(),this.cleanupMobileStickyBehavior();const t=this.tabContainer?.querySelector(".mobile-tabs-slider");t&&t.remove(),this.tabContainer?.classList.remove("has-slider-element"),this.sliderUpdateTimeout&&(clearTimeout(this.sliderUpdateTimeout),this.sliderUpdateTimeout=null),this.fadeTimeout&&(clearTimeout(this.fadeTimeout),this.fadeTimeout=null),this.fadeInTimeout&&(clearTimeout(this.fadeInTimeout),this.fadeInTimeout=null),this.initialRenderTimeout&&(clearTimeout(this.initialRenderTimeout),this.initialRenderTimeout=null),this.scrollResetTimeouts&&(this.scrollResetTimeouts.forEach(t=>clearTimeout(t)),this.scrollResetTimeouts.clear()),this.tabsWrapper=null,this.tabContainer=null,this.tabButtons=null,this.postsContent=null,this.projectsContent=null,this.waresContent=null,this.searchBar=null,this.searchTrigger=null,this.searchReveal=null,this.tabsSearchInput=null,this.tabsSearchClear=null,this.originalSearchInput=null,this.inlineSearchContainer=null,this.userSelectedTab=null,this.currentDeviceType=null,this._mobileStickyState=null,this.tabScrollStates&&this.tabScrollStates.clear(),this.animationSuppressedUntil=0,this.searchBarVisibilityTimeout&&(clearTimeout(this.searchBarVisibilityTimeout),this.searchBarVisibilityTimeout=null),this.pendingLayoutCleanup=null,this.searchOverlayOpen=!1}initializeDesktopView(){"desktop"===this.currentDeviceType&&(this.ensurePaneClasses(),this.postsContent&&(this.postsContent.style.display="block",this.postsContent.classList.add("is-visible"),this.postsContent.setAttribute("aria-hidden","false")),this.projectsContent&&(this.projectsContent.style.display="block",this.projectsContent.classList.add("is-visible"),this.projectsContent.setAttribute("aria-hidden","false")),this.waresContent&&(this.waresContent.style.display="block",this.waresContent.classList.add("is-visible"),this.waresContent.setAttribute("aria-hidden","false")),setTimeout(()=>{this.checkDesktopContentRendering()},1e3),this.tabsWrapper&&(this.tabsWrapper.style.display="none"))}checkDesktopContentRendering(){if("desktop"!==this.currentDeviceType)return;const t=this.postsContent?.querySelectorAll(".post-list-item")||[],e=this.projectsContent?.querySelectorAll(".portfolio-item")||[],i=this.waresContent?.querySelectorAll(".wares-card")||[];0===t.length&&this.postsContent&&(this.postsContent.style.display="none",setTimeout(()=>{this.postsContent.style.display="block"},100)),0===e.length&&this.projectsContent&&(this.projectsContent.style.display="none",setTimeout(()=>{this.projectsContent.style.display="block"},100)),0===i.length&&this.waresContent&&(this.waresContent.style.display="none",setTimeout(()=>{this.waresContent.style.display="block"},100))}initializeSlider(){if(!this.tabContainer||this.tabButtons.length<2)return;let t=this.tabContainer.querySelector(".mobile-tabs-slider");t||(t=document.createElement("div"),t.className="mobile-tabs-slider",this.tabContainer.appendChild(t)),this.tabContainer.classList.add("has-slider-element"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.updateSlider()})})}updateSlider(){if(this.tabContainer||this.cacheElements(),!this.tabContainer||!this.tabButtons||this.tabButtons.length<2)return;const t=this.tabContainer.querySelector(`${this.config.tabButtonSelector}.${this.config.activeClass}`);if(!t)return;const e=this.tabContainer.querySelector(".mobile-tabs-slider");if(e)try{if(null===this.tabContainer.offsetParent)return;const i=t.getBoundingClientRect(),s=this.tabContainer.getBoundingClientRect();if(s.width<=0||i.width<=0)return;const n=window.getComputedStyle(this.tabContainer),a=parseFloat(n.paddingLeft)||4,r=i.left-s.left,o=i.width;e.style.width=`${o}px`,e.style.transform=`translateX(${r}px)`,e.style.top=`${a}px`,e.style.height=`calc(100% - ${2*a}px)`,this.updateSearchTriggerPosition()}catch(t){}}validateActiveState(){if(!(this.tabButtons&&0!==this.tabButtons.length||(this.cacheElements(),this.tabButtons&&0!==this.tabButtons.length)))return null;let t=[];this.tabButtons.forEach(e=>{e&&e.classList&&e.classList.contains(this.config.activeClass)&&t.push(e)});let e=this.userSelectedTab;if(e&&1===t.length&&t[0].dataset.type===e)return this.showContent(e,{animate:!1}),this.updateSlider(),e;if(this.tabButtons.forEach(t=>{t.classList.remove(this.config.activeClass),t.setAttribute("aria-selected","false")}),!e&&this.tabContainer.dataset.activeTab)e=this.tabContainer.dataset.activeTab;else if(!e){const t=new URLSearchParams(window.location.search).get("tab");if(!t||"portfolio"!==t&&"blog"!==t&&"wares"!==t){const t=window.location.pathname;if(t.includes("/20")&&"/"!==t&&!t.includes("?")&&!document.querySelector(".blog-content"))return null;const i=document.referrer,s=i&&i.includes("/20")&&!i.includes("#")&&i!==window.location.href,n=i&&i.includes("/wares");e=s?"portfolio":n?"wares":"blog"}else e=t}const i=Array.from(this.tabButtons).find(t=>t.dataset.type===e);if(i)return i.classList.add(this.config.activeClass),i.setAttribute("aria-selected","true"),this.tabContainer.setAttribute("data-active-tab",e),this.showContent(e,{animate:!1}),this.updateSlider(),e;if(this.tabButtons.length>0){const t=this.tabButtons[0];return e=t.dataset.type,t.classList.add(this.config.activeClass),t.setAttribute("aria-selected","true"),this.tabContainer.setAttribute("data-active-tab",e),this.showContent(e,{animate:!1}),this.updateSlider(),e}return null}showContent(t,e={}){const{animate:i=!0}=e;if(!(this.postsContent&&this.projectsContent&&this.waresContent||(this.cacheElements(),this.postsContent&&this.projectsContent&&this.waresContent)))return void this.markInitialRenderComplete(t,0);this.ensurePaneClasses();const s="blog"===t?this.postsContent:"portfolio"===t?this.projectsContent:this.waresContent,n=[this.postsContent,this.projectsContent,this.waresContent].find(t=>t&&t.classList.contains("is-visible"))||null,a=i&&this.initialRenderComplete&&!this.areAnimationsSuppressed();if("desktop"===this.currentDeviceType)return[this.postsContent,this.projectsContent,this.waresContent].forEach(t=>{t&&(t.style.display="block",t.classList.add("is-visible"),t.setAttribute("aria-hidden","false"))}),this.searchBar&&(this.searchBar.style.display="block"),this.tabsWrapper&&(this.tabsWrapper.style.display="none"),this.resetScrollPositionIfNeeded("blog",this.postsContent),this.resetScrollPositionIfNeeded("portfolio",this.projectsContent),this.resetScrollPositionIfNeeded("wares",this.waresContent),void this.markInitialRenderComplete(t,0);if(this.tabsWrapper&&(this.tabsWrapper.style.display="block"),"blog"===t&&s){const{totalDuration:e,fadeOutDuration:i}=this.applyTabFade(s,n&&n!==s?n:this.projectsContent,a);this.scheduleSearchBarVisibility(!0,a?i:0),window.initializePostsOnlyButton&&window.initializePostsOnlyButton(),this.scheduleScrollReset("blog",s,a,e),this.markInitialRenderComplete(t,e),setTimeout(()=>{this.updateSearchTriggerVisibility()},a?e+50:50)}else if("portfolio"===t&&s){const{totalDuration:e,fadeOutDuration:i}=this.applyTabFade(s,n&&n!==s?n:this.postsContent,a);this.scheduleSearchBarVisibility(!1,a?i:0),window.initializeProjectToggle&&window.initializeProjectToggle(),this.scheduleScrollReset("portfolio",s,a,e),this.markInitialRenderComplete(t,e),this.hideSearchTrigger(),setTimeout(()=>{document.dispatchEvent(new Event("portfolio-loaded")),window._notebookCarousel&&window._notebookCarousel.reinitialize&&window._notebookCarousel.reinitialize()},50)}else if("wares"===t&&s){const{totalDuration:e,fadeOutDuration:i}=this.applyTabFade(s,n&&n!==s?n:this.postsContent,a);this.scheduleSearchBarVisibility(!1,a?i:0),this.scheduleScrollReset("wares",s,a,e),this.hideSearchTrigger(),setTimeout(()=>{this.resetWaresCarouselScroll(s)},a?e+50:50),this.markInitialRenderComplete(t,e)}else this.markInitialRenderComplete(t,0)}switchTab(t,e=!1){this.searchOverlayOpen&&this.closeSearchOverlay();const i=this.tabContainer?.dataset?.activeTab||Array.from(this.tabButtons||[]).find(t=>t.classList?.contains(this.config.activeClass))?.dataset?.type||null,s=!history.state||history.state.fromTab!==t||history.state.contentType!==t,n=e=>{const i=e||`${window.location.pathname}${window.location.search}${window.location.hash}`,s={...history.state||{},path:i,isInitial:!0,isDynamic:!1,fromTab:t,contentType:t};history.replaceState(s,"",i)};if(!this.tabContainer||!this.tabButtons||0===this.tabButtons.length)return;if(i===t)return void(s&&n());if(e){this.userSelectedTab=t,window.soundEffects&&window.soundEffects.isEnabled()&&window.soundEffects.play("slider");const e=new URLSearchParams(window.location.search);e.has("tab")?(e.delete("tab"),n(e.toString()?"?"+e.toString():"/")):n()}else s&&n();this.tabButtons.forEach(t=>{t.classList.remove(this.config.activeClass),t.setAttribute("aria-selected","false")});const a=Array.from(this.tabButtons).find(e=>e.dataset.type===t);a&&(a.classList.add(this.config.activeClass),a.setAttribute("aria-selected","true")),this.tabContainer.setAttribute("data-active-tab",t),this.showContent(t),this.sliderUpdateTimeout&&clearTimeout(this.sliderUpdateTimeout),this.sliderUpdateTimeout=setTimeout(()=>this.updateSlider(),16)}handleResize(){this.suppressAnimations();const t=this.getDeviceType();t!==this.currentDeviceType&&(this.currentDeviceType=t,this.handleDeviceChange(!0)),this.updateSlider(),requestAnimationFrame(()=>{requestAnimationFrame(()=>{this.updateSlider()})}),this.ensureTabsVisibleInTabletMode(),this.validateActiveState(),"mobile"===this.currentDeviceType&&this.applyMobileOverflowFixes()}getDeviceType(){return window.innerWidth<=768?"mobile":"tablet"}handleDeviceChange(t=!1){if(t&&this.suppressAnimations(),"mobile"===this.currentDeviceType||"tablet"===this.currentDeviceType){this.tabsWrapper&&(this.tabsWrapper.style.display="block");const e=this.validateActiveState(),i=Boolean(t);this.showContent(e,{animate:!i}),this.ensureTabsVisibleInTabletMode(),this.resetScrollContainersForDevice(),setTimeout(()=>this.updateSlider(),50),this.applyMobileOverflowFixes(),"mobile"===this.currentDeviceType?this.setupMobileStickyBehavior():this.cleanupMobileStickyBehavior()}else this.postsContent&&this.projectsContent&&(this.postsContent.style.display="block",this.projectsContent.style.display="block",this.postsContent.style.opacity="1",this.projectsContent.style.opacity="1"),this.tabsWrapper&&(this.tabsWrapper.style.display="none"),this.searchBar&&(this.searchBar.style.display="block"),this.clearMobileOverflowFixes(),this.resetScrollContainersForDevice(),this.cleanupMobileStickyBehavior()}ensureTabsVisibleInTabletMode(){this.tabsWrapper&&("tablet"===this.currentDeviceType?this.tabsWrapper.style.display="block":"desktop"===this.currentDeviceType&&(this.tabsWrapper.style.display="none"))}applyMobileOverflowFixes(){this.tabsWrapper&&("mobile"!==this.currentDeviceType?"tablet"===this.currentDeviceType?(this._mobileStickyState||(this._mobileStickyState={position:this.tabsWrapper.style.position||"",top:this.tabsWrapper.style.top||"",zIndex:this.tabsWrapper.style.zIndex||""}),this.tabsWrapper.style.position="sticky",this.tabsWrapper.style.top="0px",this.tabsWrapper.style.zIndex||(this.tabsWrapper.style.zIndex="100")):this.clearMobileOverflowFixes():this.tabsWrapper.style.zIndex||(this.tabsWrapper.style.zIndex="1000"))}clearMobileOverflowFixes(){if(this.tabsWrapper)if(this._mobileStickyState){const{position:t,top:e,zIndex:i}=this._mobileStickyState;this.tabsWrapper.style.position=t,this.tabsWrapper.style.top=e,this.tabsWrapper.style.zIndex=i}else this.tabsWrapper.style.position="",this.tabsWrapper.style.top="",this.tabsWrapper.style.zIndex=""}setupMobileStickyBehavior(){if("mobile"!==this.currentDeviceType)return;const t=document.querySelector(".blog"),e=document.querySelector(".blog-header");if(!t||!e||!this.tabsWrapper)return;if(this.stickyPlaceholder)return;this.stickyPlaceholder=document.createElement("div"),this.stickyPlaceholder.className="tabs-sticky-placeholder",this.stickyPlaceholder.style.display="none",this.tabsWrapper.parentNode.insertBefore(this.stickyPlaceholder,this.tabsWrapper),this.isStickyFixed=!1;const i=()=>{const t=e.getBoundingClientRect().bottom<=0;t&&!this.isStickyFixed?(this.isStickyFixed=!0,this.stickyPlaceholder.style.height=`${this.tabsWrapper.offsetHeight}px`,this.stickyPlaceholder.style.display="block",this.tabsWrapper.classList.add("is-sticky-fixed")):!t&&this.isStickyFixed&&(this.isStickyFixed=!1,this.stickyPlaceholder.style.display="none",this.tabsWrapper.classList.remove("is-sticky-fixed"))};let s=!1;this.boundListeners.handleStickyScroll=()=>{s||(requestAnimationFrame(()=>{i(),s=!1}),s=!0)},window.addEventListener("scroll",this.boundListeners.handleStickyScroll,{passive:!0}),this.stickyScrollContainer=window,i()}cleanupMobileStickyBehavior(){this.boundListeners.handleStickyScroll&&this.stickyScrollContainer&&(this.stickyScrollContainer.removeEventListener("scroll",this.boundListeners.handleStickyScroll),this.boundListeners.handleStickyScroll=null,this.stickyScrollContainer=null),this.stickyPlaceholder&&this.stickyPlaceholder.parentNode&&(this.stickyPlaceholder.parentNode.removeChild(this.stickyPlaceholder),this.stickyPlaceholder=null),this.tabsWrapper&&this.tabsWrapper.classList.remove("is-sticky-fixed"),this.isStickyFixed=!1}resetScrollContainersForDevice(){const t=t=>{t&&(t.style.removeProperty("height"),t.style.removeProperty("max-height"),t.style.removeProperty("min-height"),t.style.removeProperty("overflow"),t.style.removeProperty("overflow-y"),t.style.removeProperty("overflow-x"),t.style.removeProperty("position"),t.style.removeProperty("top"),t.style.removeProperty("right"),t.style.removeProperty("bottom"),t.style.removeProperty("left"),t.style.removeProperty("width"))},e=()=>{const e=document.querySelector(".blog");if(!e)return;const i=e.querySelector(".blog-content"),s=e.querySelectorAll(".content-wrapper"),n=e.querySelectorAll(".content-inner-wrapper");t(e),t(i),s.forEach(t),n.forEach(t)};requestAnimationFrame(()=>{requestAnimationFrame(e)})}ensurePaneClasses(){[this.postsContent,this.projectsContent,this.waresContent].forEach(t=>{t&&!t.classList.contains("mobile-tab-pane")&&t.classList.add("mobile-tab-pane")})}applyTabFade(t,e,i){if(!t)return{totalDuration:0,fadeOutDuration:0};this.ensurePaneClasses(),this.fadeTimeout&&(clearTimeout(this.fadeTimeout),this.fadeTimeout=null),this.fadeInTimeout&&(clearTimeout(this.fadeInTimeout),this.fadeInTimeout=null);const s=this.config.transitionDuration,n=e&&e!==t?e:null,a=Math.max(120,Math.round(.35*s)),r=n?2*s+a:s,o=i&&n?s:0;let l=null;if("function"==typeof this.pendingLayoutCleanup){try{this.pendingLayoutCleanup()}catch(t){}this.pendingLayoutCleanup=null}if(!i||!n)return t.style.display="block",t===this.waresContent&&this.resetWaresCarouselScroll(t),t.classList.add("is-visible"),t.setAttribute("aria-hidden","false"),n&&(n.classList.remove("is-visible"),n.style.display="none",n.setAttribute("aria-hidden","true")),{totalDuration:0,fadeOutDuration:0};t.style.display="block",t===this.waresContent&&this.resetWaresCarouselScroll(t),t.classList.remove("is-visible"),t.setAttribute("aria-hidden","true"),n.style.display="block",n.classList.add("is-visible"),n.setAttribute("aria-hidden","true");try{const e=n.parentElement||t.parentElement;if(e){const i=window.getComputedStyle(e),s=e.style.position,a=e.style.height,r=e.style.minHeight,o={position:t.style.position,top:t.style.top,left:t.style.left,right:t.style.right,bottom:t.style.bottom,width:t.style.width},h={position:n.style.position,top:n.style.top,left:n.style.left,right:n.style.right,bottom:n.style.bottom,width:n.style.width},c="static"===i.position||!i.position,u=e.offsetHeight,d=t.offsetHeight,p=n.offsetHeight,b=Math.max(u,d,p);c&&(e.style.position="relative"),!Number.isNaN(b)&&b>0&&(e.style.height=`${b}px`,e.style.minHeight=`${b}px`);const y=t=>{t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.right="0",t.style.width="100%"};y(t),y(n),l=()=>{t.style.position=o.position||"",t.style.top=o.top||"",t.style.left=o.left||"",t.style.right=o.right||"",t.style.bottom=o.bottom||"",t.style.width=o.width||"",n.style.position=h.position||"",n.style.top=h.top||"",n.style.left=h.left||"",n.style.right=h.right||"",n.style.bottom=h.bottom||"",n.style.width=h.width||"",c&&(e.style.position=s||""),a?e.style.height=a:e.style.removeProperty("height"),r?e.style.minHeight=r:e.style.removeProperty("min-height")}}}catch(t){l=null}return requestAnimationFrame(()=>{n.classList.remove("is-visible")}),this.fadeTimeout=window.setTimeout(()=>{n.style.display="none",this.fadeTimeout=null},s),this.fadeInTimeout=window.setTimeout(()=>{t.setAttribute("aria-hidden","false"),t.classList.add("is-visible"),"function"==typeof l&&(l(),this.pendingLayoutCleanup===l&&(this.pendingLayoutCleanup=null)),this.fadeInTimeout=null},s+a),"function"==typeof l&&(this.pendingLayoutCleanup=l),{totalDuration:r,fadeOutDuration:o}}scheduleSearchBarVisibility(t,e=0){if(!this.searchBar)return;this.searchBarVisibilityTimeout&&(clearTimeout(this.searchBarVisibilityTimeout),this.searchBarVisibilityTimeout=null);const i=()=>{const e=window.getComputedStyle(this.searchBar).display,i="none"!==e;if(t&&!i){const t=this.searchBar.dataset.originalDisplay||"";this.searchBar.style.display=t,delete this.searchBar.dataset.originalDisplay}else!t&&i&&(this.searchBar.dataset.originalDisplay||(this.searchBar.dataset.originalDisplay="none"===e?"":e),this.searchBar.style.display="none");this.searchBarVisibilityTimeout=null},s=t?100:0,n=Math.max(0,e+s);n>0?this.searchBarVisibilityTimeout=window.setTimeout(i,n):i()}scheduleScrollReset(t,e,i,s=0){if(!e)return;const n=i?s+120:80;this.scrollResetTimeouts.has(t)&&clearTimeout(this.scrollResetTimeouts.get(t));const a=window.setTimeout(()=>{this.resetScrollPositionIfNeeded(t,e,{behavior:"auto"}),this.scrollResetTimeouts.delete(t)},n);this.scrollResetTimeouts.set(t,a)}resetScrollPositionIfNeeded(t,e,i={}){if(!e)return;const{behavior:s="smooth"}=i,n=e.closest(".content-wrapper");if(!n)return;const a=this.tabScrollStates.get(t);a?.initialScrollResetDone||((n.scrollTop||0)<=0?this.tabScrollStates.set(t,{initialScrollResetDone:!0}):requestAnimationFrame(()=>{ScrollUtility&&"function"==typeof ScrollUtility.scrollToElement?ScrollUtility.scrollToElement(n,{behavior:s,block:"start"}):"function"==typeof n.scrollTo?n.scrollTo({top:0,behavior:s}):n.scrollTop=0,"wares"===t&&this.resetWaresCarouselScroll(e),this.tabScrollStates.set(t,{initialScrollResetDone:!0})}))}resetWaresCarouselScroll(t){if(!t)return;const e=t.querySelector(".wares-grid");if(!e)return;const i=e.querySelector(".wares-card");if(i){const t=e.style.scrollSnapType;e.style.scrollSnapType="none";const s=e.getBoundingClientRect(),n=i.getBoundingClientRect(),a=n.left-s.left+e.scrollLeft-s.width/2+n.width/2;e.scrollLeft=Math.max(0,a),requestAnimationFrame(()=>{e.style.scrollSnapType=t||"",e.classList.add("scroll-ready")})}else e.scrollLeft=0,e.classList.add("scroll-ready")}markInitialRenderComplete(t,e=0){if(this.initialRenderComplete)return;let i=e;(!i||i<0)&&(i=Math.max(250,this.config.transitionDuration+150));const s=()=>{if(this.initialRenderComplete)return;this.initialRenderComplete=!0,this.initialRenderTimeout=null;const e=t||this.tabContainer?.dataset?.activeTab||Array.from(this.tabButtons||[]).find(t=>t.classList?.contains(this.config.activeClass))?.dataset?.type||null;"undefined"!=typeof document&&document.body&&(document.body.classList.add("tabs-initial-rendered"),e&&document.body.setAttribute("data-active-tab",e));try{const t={activeTab:e};document.dispatchEvent(new CustomEvent("mobileTabs:initial-render",{detail:t}))}catch(t){}};i>0?(this.initialRenderTimeout&&clearTimeout(this.initialRenderTimeout),this.initialRenderTimeout=window.setTimeout(s,i)):s()}suppressAnimations(t=this.config.transitionDuration+200){if("undefined"==typeof Date)return;const e=Date.now()+Math.max(0,t);this.animationSuppressedUntil=Math.max(this.animationSuppressedUntil||0,e)}areAnimationsSuppressed(){return!!this.animationSuppressedUntil&&!(Date.now()>=this.animationSuppressedUntil&&(this.animationSuppressedUntil=0,1))}setupSearchIntegration(){console.log("[MobileTabs] Setting up search integration...",{searchTrigger:!!this.searchTrigger,searchReveal:!!this.searchReveal,tabsSearchInput:!!this.tabsSearchInput,inlineSearchContainer:!!this.inlineSearchContainer,deviceType:this.currentDeviceType}),this.searchTrigger&&this.searchReveal&&this.tabsSearchInput?(document.body.classList.add("tabs-search-available"),this.setupSearchVisibilityObserver(),this.boundListeners.handleSearchTriggerClick=t=>{t.preventDefault(),t.stopPropagation(),this.searchOverlayOpen?(console.log("[MobileTabs] Search trigger clicked - closing"),this.closeSearchOverlay()):(console.log("[MobileTabs] Search trigger clicked - opening"),this.openSearchOverlay())},this.searchTrigger.addEventListener("click",this.boundListeners.handleSearchTriggerClick),console.log("[MobileTabs] Click listener attached to search trigger"),this.boundListeners.handleSearchInputSync=this.syncSearchInputs.bind(this),this.tabsSearchInput.addEventListener("input",this.boundListeners.handleSearchInputSync),this.originalSearchInput&&(this.boundListeners.handleOriginalSearchInput=()=>{this.tabsSearchInput&&this.tabsSearchInput.value!==this.originalSearchInput.value&&(this.tabsSearchInput.value=this.originalSearchInput.value,this.updateSearchClearVisibility())},this.originalSearchInput.addEventListener("input",this.boundListeners.handleOriginalSearchInput)),this.boundListeners.handleSearchClear=this.clearSearchInput.bind(this),this.tabsSearchClear?.addEventListener("click",this.boundListeners.handleSearchClear),this.boundListeners.handleSearchKeydown=t=>{"Escape"===t.key&&this.searchOverlayOpen&&(t.preventDefault(),this.closeSearchOverlay())},document.addEventListener("keydown",this.boundListeners.handleSearchKeydown),this.boundListeners.handleSearchPostsOnlyClick=()=>{this.togglePostsOnlyFilter()},this.tabsSearchPostsOnly?.addEventListener("click",this.boundListeners.handleSearchPostsOnlyClick),console.log("[MobileTabs] Search integration initialized")):console.log("[MobileTabs] Search integration skipped - missing elements")}setupSearchVisibilityObserver(){this.inlineSearchContainer||(this.inlineSearchContainer=this.postsContent?.querySelector(".search-container")),this.inlineSearchContainer||console.log("[MobileTabs] No inline search container found yet - will check lazily");let t=!1;this.boundListeners.handleSearchScroll=()=>{t||(requestAnimationFrame(()=>{this.checkSearchVisibility(),t=!1}),t=!0)};const e=new Set;this.postsContent&&e.add(this.postsContent);const i=this.postsContent?.closest(".content-wrapper"),s=this.postsContent?.closest(".blog-content"),n=document.querySelector(".blog");i&&e.add(i),s&&e.add(s),n&&e.add(n),e.add(window),e.add(document),e.forEach(t=>{t.addEventListener("scroll",this.boundListeners.handleSearchScroll,{passive:!0})}),this.scrollTargets=e,console.log("[MobileTabs] Scroll listeners set up on",e.size,"targets"),requestAnimationFrame(()=>{this.updateSearchTriggerPosition(),this.checkSearchVisibility()})}checkSearchVisibility(){if(this.inlineSearchContainer||(this.inlineSearchContainer=this.postsContent?.querySelector(".search-container")),!this.inlineSearchContainer||!this.searchTrigger)return;const t="blog"===(this.tabContainer?.dataset?.activeTab||"blog"),e="mobile"===this.currentDeviceType||"tablet"===this.currentDeviceType||"desktop"===this.currentDeviceType,i=this.postsContent;if(!i||!i.classList.contains("is-visible"))return void this.hideSearchTrigger();const s=this.inlineSearchContainer.getBoundingClientRect(),n=this.tabContainer?.offsetHeight||60,a=s.bottom<n,r=s.top>n&&s.bottom>0;if(this.searchOverlayOpen&&r)this.transferSearchToInline();else{if(this.searchOverlayOpen){const t=document.activeElement===this.tabsSearchInput,e=this.tabsSearchInput?.value?.length>0;if(!t&&!e)return void this.closeSearchOverlay(!0)}if(t&&e&&a&&!this.searchOverlayOpen){const t=document.activeElement===this.originalSearchInput,e=this.originalSearchInput?.value?.length>0;if(t||e)return void this.transferSearchToTabs()}t&&e&&!this.searchOverlayOpen&&a?(this.updateSearchTriggerPosition(),this.searchTrigger.classList.remove("is-hiding"),this.searchTrigger.classList.add("is-visible")):this.hideSearchTrigger()}}transferSearchToInline(){if(!this.searchOverlayOpen)return;console.log("[MobileTabs] Transferring search to inline search bar");const t=this.tabsSearchInput?.value||"",e=document.activeElement===this.tabsSearchInput;this.closeSearchOverlay(!1),this.originalSearchInput&&(this.originalSearchInput.value!==t&&(this.originalSearchInput.value=t),e&&t&&(this.originalSearchInput.focus(),this.originalSearchInput.setSelectionRange(t.length,t.length)))}transferSearchToTabs(){if(this.searchOverlayOpen)return;console.log("[MobileTabs] Transferring search to tabs overlay");const t=this.originalSearchInput?.value||"",e=document.activeElement===this.originalSearchInput;this.originalSearchInput?.blur(),this.openSearchOverlay(),this.tabsSearchInput&&t&&(this.tabsSearchInput.value=t,e&&this.tabsSearchInput.setSelectionRange(t.length,t.length))}openSearchOverlay(){if(!this.searchReveal||!this.tabsSearchInput||this.searchOverlayOpen)return;this.savedScrollPosition=window.scrollY,this.searchOverlayOpen=!0;const t=this.tabContainer?.getBoundingClientRect(),e=(t?.width||600)-6-24;this.tabContainer?.style.setProperty("--slider-end-left",`${e}px`),this.tabContainer?.style.setProperty("--slider-end-size","24px"),this.tabContainer?.classList.add("search-reveal-active"),this.searchReveal.setAttribute("aria-hidden","false"),this.searchTrigger?.setAttribute("aria-expanded","true"),this.searchTrigger?.classList.add("is-close-mode"),this.originalSearchInput&&this.tabsSearchInput&&(this.tabsSearchInput.value=this.originalSearchInput.value),this.syncPostsOnlyState(),setTimeout(()=>{this.tabsSearchInput?.focus(),this.updateSearchClearVisibility()},350),window.soundEffects&&window.soundEffects.isEnabled()&&window.soundEffects.play("click"),console.log("[MobileTabs] Search reveal opened")}closeSearchOverlay(t=!0){if(this.searchReveal&&this.searchOverlayOpen){if(this.searchOverlayOpen=!1,this.tabContainer?.classList.remove("search-reveal-active"),this.searchReveal.setAttribute("aria-hidden","true"),this.searchTrigger?.setAttribute("aria-expanded","false"),this.searchTrigger?.classList.remove("is-close-mode"),t){if(this.tabsSearchInput&&(this.tabsSearchInput.value=""),this.originalSearchInput){this.originalSearchInput.value="";const t=new Event("input",{bubbles:!0});this.originalSearchInput.dispatchEvent(t)}this.updateSearchClearVisibility(),"number"==typeof this.savedScrollPosition&&(window.scrollTo({top:this.savedScrollPosition,behavior:"smooth"}),this.savedScrollPosition=null)}else this.savedScrollPosition=null;this.tabsSearchInput?.blur(),setTimeout(()=>{this.updateSlider(),this.updateSearchTriggerVisibility()},350),window.soundEffects&&window.soundEffects.isEnabled()&&window.soundEffects.play("click"),console.log("[MobileTabs] Search reveal closed")}}syncSearchInputs(){if(!this.tabsSearchInput||!this.originalSearchInput)return;this.originalSearchInput.value=this.tabsSearchInput.value;const t=new Event("input",{bubbles:!0});this.originalSearchInput.dispatchEvent(t),this.updateSearchClearVisibility()}clearSearchInput(){this.tabsSearchInput&&(this.tabsSearchInput.value="",this.syncSearchInputs(),this.tabsSearchInput.focus())}togglePostsOnlyFilter(){this.tabsSearchPostsOnly&&this.originalPostsOnlyButton&&(this.originalPostsOnlyButton.click(),setTimeout(()=>{this.syncPostsOnlyState()},10))}syncPostsOnlyState(){if(!this.tabsSearchPostsOnly||!this.originalPostsOnlyButton)return;const t=this.originalPostsOnlyButton.classList.contains("active");this.tabsSearchPostsOnly.classList.toggle("active",t)}updateSearchClearVisibility(){if(!this.tabsSearchClear||!this.tabsSearchInput)return;const t=this.tabsSearchInput.value.length>0;this.tabsSearchClear.style.display=t?"flex":"none"}updateSearchTriggerPosition(){if(!this.searchTrigger||!this.tabContainer)return;const t=this.tabContainer.querySelector('.tab-button[data-type="blog"]');if(!t)return;const e=this.tabContainer.getBoundingClientRect(),i=t.getBoundingClientRect().right-e.left-24-4;this.tabContainer.style.setProperty("--trigger-left",`${i}px`);const s=e.width-6-24;this.tabContainer.style.setProperty("--slider-end-left",`${s}px`)}hideSearchTrigger(t=!0){this.searchTrigger&&this.searchTrigger.classList.contains("is-visible")&&(t?(this.searchTrigger.classList.add("is-hiding"),this.searchTrigger.classList.remove("is-visible"),setTimeout(()=>{this.searchTrigger?.classList.remove("is-hiding")},200)):this.searchTrigger.classList.remove("is-visible","is-hiding"))}updateSearchTriggerVisibility(){if(!this.searchTrigger||!this.inlineSearchContainer)return;const t="blog"===(this.tabContainer?.dataset?.activeTab||"blog"),e="mobile"===this.currentDeviceType||"tablet"===this.currentDeviceType||"desktop"===this.currentDeviceType;if(!t||!e||this.searchOverlayOpen)return void this.hideSearchTrigger();const i=this.inlineSearchContainer.getBoundingClientRect();i.top>60&&i.bottom>0?this.hideSearchTrigger():(this.searchTrigger.classList.remove("is-hiding"),this.searchTrigger.classList.add("is-visible"))}cleanupSearchIntegration(){this.boundListeners.handleSearchTriggerClick&&this.searchTrigger?.removeEventListener("click",this.boundListeners.handleSearchTriggerClick),this.boundListeners.handleSearchInputSync&&this.tabsSearchInput?.removeEventListener("input",this.boundListeners.handleSearchInputSync),this.boundListeners.handleOriginalSearchInput&&this.originalSearchInput?.removeEventListener("input",this.boundListeners.handleOriginalSearchInput),this.boundListeners.handleSearchClear&&this.tabsSearchClear?.removeEventListener("click",this.boundListeners.handleSearchClear),this.boundListeners.handleSearchKeydown&&document.removeEventListener("keydown",this.boundListeners.handleSearchKeydown),this.boundListeners.handleSearchPostsOnlyClick&&this.tabsSearchPostsOnly?.removeEventListener("click",this.boundListeners.handleSearchPostsOnlyClick),this.boundListeners.handleSearchScroll&&this.scrollTargets&&(this.scrollTargets.forEach(t=>{t?.removeEventListener("scroll",this.boundListeners.handleSearchScroll)}),this.scrollTargets.clear()),document.body.classList.remove("tabs-search-available"),this.searchOverlayOpen=!1}}
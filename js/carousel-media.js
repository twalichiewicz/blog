export class CarouselMedia{constructor(e,t){this.element=e,this.state=t,this.mediaCache=new Map,this.initializeMedia(),this.setupLazyLoading(),this.applySafariFixes()}initializeMedia(){this.element.querySelectorAll(".carousel-slide").forEach((e,t)=>{const s=e.querySelector("img");s&&this.processImage(s,t);const a=e.querySelector("video");a&&this.processVideo(a,t);const i=e.querySelector("iframe");i&&this.processIframe(i,t)})}processImage(e,t){const s=e.getAttribute("src")||"",a=this.resolveImagePath(s);a!==e.src&&(e.src=a),e.classList.add("carousel-image"),e.complete?e.classList.add("loaded"):(e.addEventListener("load",()=>{e.classList.add("loaded"),this.onMediaLoaded("image",t)}),e.addEventListener("error",()=>{console.error(`Failed to load image: ${e.src}`),this.onMediaError("image",t)})),this.mediaCache.set(`image-${t}`,{type:"image",element:e,src:a,loaded:e.complete})}processVideo(e,t){e.classList.add("carousel-video"),e.hasAttribute("playsinline")||e.setAttribute("playsinline",""),e.addEventListener("loadedmetadata",()=>{this.onMediaLoaded("video",t)}),e.addEventListener("error",()=>{console.error(`Failed to load video: ${e.src}`),this.onMediaError("video",t)}),this.mediaCache.set(`video-${t}`,{type:"video",element:e,loaded:e.readyState>=2}),this.setupVideoAutoplay(e,t)}processIframe(e,t){e.classList.add("carousel-iframe");const s=document.createElement("div");s.className="carousel-iframe-wrapper",e.parentNode.insertBefore(s,e),s.appendChild(e);const a=e.width||16,i=(e.height||9)/a*100;s.style.paddingBottom=`${i}%`,this.mediaCache.set(`iframe-${t}`,{type:"iframe",element:e,wrapper:s,loaded:!0})}resolveImagePath(e){if(!e)return"";if(e.startsWith("http://")||e.startsWith("https://"))return e;const t=this.detectProjectPath();return e.startsWith("./")?t+e.substring(2):e.startsWith("/")?(e.match(/^\/\d{4}\/\d{2}\/\d{2}\//),e):t+e}detectProjectPath(){const e=window.location.pathname.match(/^(\/\d{4}\/\d{2}\/\d{2}\/[^/]+\/)/);if(e)return e[1];const t=this.element.closest(".project-wrapper")?.querySelector('img[src*="/20"]');if(t){const e=t.src.match(/^.*?(\/\d{4}\/\d{2}\/\d{2}\/[^/]+\/)/);if(e)return e[1]}return"/"}setupLazyLoading(){if("IntersectionObserver"in window){const e={root:this.element,rootMargin:"50px",threshold:.01};this.observer=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target,s=Array.from(t.parentElement.children).indexOf(t);this.loadMediaInSlide(s)}})},e),this.element.querySelectorAll(".carousel-slide").forEach(e=>this.observer.observe(e))}}loadMediaInSlide(e){const t=this.mediaCache.get(`image-${e}`);if(t&&!t.loaded){const e=t.element;e.dataset.src&&!e.src&&(e.src=e.dataset.src)}const s=this.mediaCache.get(`video-${e}`);if(s&&!s.loaded){const e=s.element;e.dataset.src&&!e.src&&(e.src=e.dataset.src)}}setupVideoAutoplay(e,t){this.state.on("indexChange",({currentIndex:s})=>{s===t?e.hasAttribute("autoplay")&&e.play().catch(()=>{}):e.paused||e.pause()})}applySafariFixes(){/^((?!chrome|android).)*safari/i.test(navigator.userAgent)&&(this.element.querySelector(".carousel-slide:first-child img"),this.element.style.webkitTransform="translateZ(0)")}onMediaLoaded(e,t){const s=this.mediaCache.get(`${e}-${t}`);s&&(s.loaded=!0),this.element.dispatchEvent(new CustomEvent("carouselMediaLoaded",{detail:{type:e,index:t}}))}onMediaError(e,t){this.element.dispatchEvent(new CustomEvent("carouselMediaError",{detail:{type:e,index:t}}))}handleResize(){this.mediaCache.forEach((e,t)=>{"iframe"===e.type&&e.wrapper})}getAllMedia(){const e=[];return this.mediaCache.forEach((t,s)=>{e.push({...t,index:parseInt(s.split("-")[1])})}),e.sort((e,t)=>e.index-t.index)}}
import{SoundRegistry,SoundRegistryHelper}from"./sound-registry.js";class SoundService{constructor(){if(SoundService.instance)return SoundService.instance;this.enabled=this.loadSetting("soundEnabled",!0),this.volume=this.loadSetting("soundVolume",.5),this.autoplayAllowed=null,this.pendingSounds=[],this.audioContext=null,this.audioBuffers=new Map,this.gainNode=null,this.audioPools=new Map,this.poolSize=4,this.loadingPromises=new Map,this.useWebAudio=this.detectWebAudioSupport(),this.supportedFormats=this.detectSupportedFormats(),this.init(),SoundService.instance=this}detectWebAudioSupport(){return void 0!==(window.AudioContext||window.webkitAudioContext)}init(){this.setupAutoplayDetection(),this.setupStorageListener(),"undefined"!=typeof window&&(window.soundService=this)}initAudioContext(){if(!this.audioContext)try{const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=this.volume,"suspended"===this.audioContext.state&&this.audioContext.resume()}catch(e){console.warn("Web Audio API not available, falling back to HTML5 Audio"),this.useWebAudio=!1}}async preloadCriticalSounds(){if(!1===this.autoplayAllowed)return;const e=SoundRegistryHelper.getPreloadSounds();e.length>0&&await this.preload(e)}detectSupportedFormats(){const e=new Audio,t={mp3:"audio/mpeg",ogg:"audio/ogg",m4a:"audio/mp4",wav:"audio/wav",webm:"audio/webm"},o={};for(const[i,s]of Object.entries(t))o[i]=""!==e.canPlayType(s);return o}setupAutoplayDetection(){const e=async()=>{this.initAudioContext();try{const e=new Audio;e.volume=0,e.src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=",await e.play(),e.pause(),this.autoplayAllowed=!0,this.processPendingSounds(),this.preloadCriticalSounds()}catch(e){this.autoplayAllowed=!1,console.info("Sound autoplay requires user interaction")}};"undefined"!=typeof document&&["click","touchstart","keydown"].forEach(t=>{document.addEventListener(t,()=>{null===this.autoplayAllowed&&e()},{once:!0,passive:!0})})}setupStorageListener(){"undefined"!=typeof window&&window.addEventListener("storage",e=>{"soundEnabled"===e.key?this.enabled="true"===e.newValue:"soundVolume"===e.key&&(this.volume=parseFloat(e.newValue)||.5,this.updateVolume())})}async loadWebAudio(e,t){if(this.audioBuffers.has(e))return this.audioBuffers.get(e);const o=await fetch(t),i=await o.arrayBuffer(),s=await this.audioContext.decodeAudioData(i);return this.audioBuffers.set(e,s),s}createAudioPool(e,t){const o=[];for(let e=0;e<this.poolSize;e++){const e=new Audio(t);e.volume=this.volume,e.preload="auto",o.push({audio:e,inUse:!1})}return this.audioPools.set(e,o),o}getPooledAudio(e){const t=this.audioPools.get(e);if(!t)return null;for(const e of t)if(!e.inUse)return e;for(const e of t)if(e.audio.ended||e.audio.paused)return e.inUse=!1,e;return t[0]}async load(e,t){if(this.useWebAudio&&this.audioBuffers.has(e))return;if(!this.useWebAudio&&this.audioPools.has(e))return;if(this.loadingPromises.has(e))return this.loadingPromises.get(e);const o="string"==typeof t?{url:t}:t,i=this.getBestFormat(o);if(!i)return void console.warn(`No supported format found for sound: ${e}`);const s=(async()=>{try{this.useWebAudio&&this.audioContext?await this.loadWebAudio(e,i):this.createAudioPool(e,i)}catch(t){console.warn(`Failed to load sound: ${e}`,t),this.useWebAudio&&this.createAudioPool(e,i)}})();this.loadingPromises.set(e,s),await s,this.loadingPromises.delete(e)}getBestFormat(e){if("string"==typeof e)return e;if(e.url)return e.url;if(e.formats)for(const t of Object.keys(e.formats))if(this.supportedFormats[t])return e.formats[t];return null}play(e,t={}){if(!this.enabled)return;if(null===this.autoplayAllowed)return void this.pendingSounds.push({name:e,options:t});if(!this.autoplayAllowed)return;const o=SoundRegistryHelper.getSoundConfig(e);if(!o)return void console.warn(`Sound not found in registry: ${e}`);const i=o.volume??1,s=t.volume??1,n=this.volume*i*s;this.useWebAudio&&this.audioBuffers.has(e)?this.playWebAudio(e,n,o.loop&&!1!==t.loop):this.audioPools.has(e)?this.playPooledAudio(e,n):this.load(e,o).then(()=>{this.play(e,t)})}playWebAudio(e,t,o=!1){const i=this.audioBuffers.get(e);if(!i||!this.audioContext)return;"suspended"===this.audioContext.state&&this.audioContext.resume();const s=this.audioContext.createBufferSource();s.buffer=i,s.loop=o;const n=this.audioContext.createGain();return n.gain.value=t,s.connect(n),n.connect(this.gainNode),s.start(0),s}playPooledAudio(e,t){const o=this.getPooledAudio(e);if(!o)return;const{audio:i}=o;o.inUse=!0,i.currentTime=0,i.volume=t;const s=i.play();s&&s.then(()=>{i.addEventListener("ended",()=>{o.inUse=!1},{once:!0})}).catch(()=>{o.inUse=!1})}async preload(e){const t=e.map(e=>{const t=SoundRegistryHelper.getSoundConfig(e);return t?this.load(e,t):(console.warn(`Sound not found in registry for preload: ${e}`),Promise.resolve())});await Promise.allSettled(t)}processPendingSounds(){if(!this.autoplayAllowed||0===this.pendingSounds.length)return;const e=[...this.pendingSounds];this.pendingSounds=[],e.forEach(({name:e,options:t})=>{this.play(e,t)})}updateVolume(){this.gainNode&&(this.gainNode.gain.value=this.volume),this.audioPools.forEach(e=>{e.forEach(e=>{e.audio.volume=this.volume})})}registerSound(e,t,o="custom"){SoundRegistryHelper.registerSound(e,t,o)}getAvailableSounds(){return Object.keys(SoundRegistryHelper.getAllSounds())}getSoundsByCategory(e){return SoundRegistryHelper.getSoundsByCategory(e)}stopAll(){this.audioPools.forEach(e=>{e.forEach(e=>{e.audio.pause(),e.audio.currentTime=0,e.inUse=!1})})}setEnabled(e){this.enabled=e,this.saveSetting("soundEnabled",e)}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.saveSetting("soundVolume",this.volume),this.updateVolume()}loadSetting(e,t){if("undefined"==typeof localStorage)return t;const o=localStorage.getItem(e);return null===o?t:"soundEnabled"===e?"true"===o:parseFloat(o)}saveSetting(e,t){"undefined"!=typeof localStorage&&localStorage.setItem(e,t.toString())}destroy(){this.stopAll(),this.audioPools.forEach(e=>{e.forEach(e=>{e.audio.src=""})}),this.audioPools.clear(),this.audioBuffers.clear(),this.audioContext&&(this.audioContext.close(),this.audioContext=null),this.loadingPromises.clear(),this.pendingSounds=[]}}export default SoundService;"undefined"!=typeof window&&(window.SoundService=SoundService);
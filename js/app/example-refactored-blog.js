import{Component}from"./core/Component.js";import{fadeIn,fadeOut}from"./utils/animations.js";import{debounce}from"./utils/helpers.js";export class BlogModule extends Component{static defaults={animationDuration:300,searchDelay:200,postsPerPage:10};constructor(e,t={}){super(e,t),this.device=t.device,this.storage=t.storage,this.eventBus=t.eventBus,this.currentFilter="all",this.searchQuery="",this.posts=[]}async init(){this.cacheElements(),this.loadState(),await this.loadPosts(),this.bindEvents(),this.setupMobileFeatures(),this.eventBus.emit("blog:ready")}cacheElements(){this.elements={postList:this.element.querySelector(".blog-list"),searchInput:this.element.querySelector(".search-input"),filterButtons:this.element.querySelectorAll(".filter-btn"),loadMoreBtn:this.element.querySelector(".load-more"),backToTopBtn:this.element.querySelector(".back-to-top")}}loadState(){this.currentFilter=this.storage.get("blog.filter")||"all",this.updateFilterUI()}async loadPosts(){this.posts=Array.from(this.elements.postList.querySelectorAll(".post")),"IntersectionObserver"in window&&this.setupLazyLoading()}bindEvents(){this.elements.searchInput&&this.on(this.elements.searchInput,"input",debounce(this.handleSearch.bind(this),this.options.searchDelay)),this.elements.filterButtons.forEach(e=>{this.on(e,"click",this.handleFilter)}),this.elements.loadMoreBtn&&this.on(this.elements.loadMoreBtn,"click",this.loadMore),this.elements.backToTopBtn&&(this.on(window,"scroll",this.handleScroll,{passive:!0}),this.on(this.elements.backToTopBtn,"click",this.scrollToTop)),this.on(window,"device:changed",this.handleDeviceChange)}setupMobileFeatures(){this.device.isMobile()&&(this.element.classList.add("mobile-optimized"),this.enableTouchGestures())}handleSearch(e){this.searchQuery=e.target.value.toLowerCase().trim(),this.filterPosts(),this.eventBus.emit("blog:search",{query:this.searchQuery})}handleFilter(e){const t=e.currentTarget;this.currentFilter=t.dataset.filter,this.updateFilterUI(),this.filterPosts(),this.storage.set("blog.filter",this.currentFilter),this.eventBus.emit("blog:filter",{filter:this.currentFilter})}async filterPosts(){const e=[];for(const t of this.posts){const s=this.matchesFilter(t),i=this.matchesSearch(t);s&&i?(await this.showPost(t),e.push(t)):await this.hidePost(t)}this.updateResultsMessage(e.length)}matchesFilter(e){return"all"===this.currentFilter||(e.dataset.categories?.split(",")||[]).includes(this.currentFilter)}matchesSearch(e){return!this.searchQuery||[e.querySelector("h3")?.textContent,e.querySelector(".excerpt")?.textContent,e.dataset.tags].join(" ").toLowerCase().includes(this.searchQuery)}async showPost(e){"none"===e.style.display&&(e.style.display="",await fadeIn(e,this.options.animationDuration))}async hidePost(e){"none"!==e.style.display&&await fadeOut(e,this.options.animationDuration)}updateFilterUI(){this.elements.filterButtons.forEach(e=>{const t=e.dataset.filter===this.currentFilter;e.classList.toggle("active",t),e.setAttribute("aria-pressed",t)})}updateResultsMessage(e){const t=this.element.querySelector(".results-message");t&&(0===e?(t.textContent="No posts found",t.classList.add("empty")):(t.textContent=`Showing ${e} post${1!==e?"s":""}`,t.classList.remove("empty")))}setupLazyLoading(){const e=this.element.querySelectorAll("img[data-src]"),t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const s=e.target;s.src=s.dataset.src,s.removeAttribute("data-src"),t.unobserve(s)}})});e.forEach(e=>t.observe(e)),this.imageObserver=t}async loadMore(){const e=this.elements.loadMoreBtn;e.disabled=!0,e.textContent="Loading...";try{const t=await this.fetchMorePosts();await this.renderNewPosts(t),t.length<this.options.postsPerPage&&(e.style.display="none")}catch(t){e.textContent="Error - Try Again"}finally{e.disabled=!1,e.textContent="Load More"}}handleScroll(){const e=window.pageYOffset>300;this.elements.backToTopBtn.classList.toggle("visible",e)}scrollToTop(e){e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})}handleDeviceChange(e){const{device:t}=e.detail;"mobile"===t.type?this.setupMobileFeatures():this.teardownMobileFeatures()}enableTouchGestures(){let e=0;this.on(this.element,"touchstart",t=>{e=t.touches[0].clientX},{passive:!0}),this.on(this.element,"touchend",t=>{const s=t.changedTouches[0].clientX,i=e-s;Math.abs(i)>50&&(i>0?this.eventBus.emit("blog:swipe",{direction:"left"}):this.eventBus.emit("blog:swipe",{direction:"right"}))},{passive:!0})}teardownMobileFeatures(){this.element.classList.remove("mobile-optimized")}destroy(){this.imageObserver&&this.imageObserver.disconnect(),super.destroy(),this.eventBus.emit("blog:destroyed")}}